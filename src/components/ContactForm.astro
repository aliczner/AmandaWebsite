---
// src/components/ContactForm.astro
export interface Props {
  apiEndpoint?: string
  rateLimitMinutes?: number
  maxMessageLength?: number
  className?: string
  showMathCaptcha?: boolean
  successMessage?: string
  errorMessage?: string
}
s

const {
  apiEndpoint = '/api/contact',
  rateLimitMinutes = 5,
  maxMessageLength = 2000,
  className = '',
  showMathCaptcha = true,
  successMessage = 'Thanks! Your message has been sent. I will get back to you shortly.',
  errorMessage = 'Oops! Something went wrong. Please try again later.',
} = Astro.props

// Generate a random math problem for the session
const mathProblems = [
  { question: 'What is 5 + 3?', answer: '8' },
  { question: 'What is 7 - 2?', answer: '5' },
  { question: 'What is 4 + 4?', answer: '8' },
  { question: 'What is 9 - 3?', answer: '6' },
  { question: 'What is 2 + 6?', answer: '8' },
  { question: 'What is 10 - 4?', answer: '6' },
]

const randomProblem =
  mathProblems[Math.floor(Math.random() * mathProblems.length)]
---

<style>
  /* Honeypot field - hidden from users */
  .honeypot {
    position: absolute !important;
    left: -9999px !important;
    width: 1px !important;
    height: 1px !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }

  /* Rate limiting message */
  .rate-limit-message {
    display: none;
    background-color: #fef3cd;
    border: 1px solid #fecf6a;
    color: #856404;
    padding: 0.75rem;
    border-radius: 0.375rem;
    margin-top: 1rem;
  }

  .contact-form {
    position: relative;
  }

  .form-field {
    margin-bottom: 1rem;
  }

  .form-label {
    display: block;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .form-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    background-color: white;
    transition:
      border-color 0.15s ease-in-out,
      box-shadow 0.15s ease-in-out;
  }

  .form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-textarea {
    resize: vertical;
    min-height: 120px;
  }

  .submit-button {
    background-color: var(--color-primary, #3b82f6);
    color: white;
    padding: 1rem 2rem;
    border: none;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
  }

  .submit-button:hover:not(:disabled) {
    background-color: var(--color-secondary, #2563eb);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .submit-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .form-message {
    margin-top: 1rem;
    text-align: center;
    font-size: 0.875rem;
  }

  .form-message.success {
    color: #065f46;
  }

  .form-message.error {
    color: #dc2626;
  }
</style>

<form
  id="contact-form"
  class={`contact-form ${className}`}
  data-api-endpoint={apiEndpoint}
  data-rate-limit={rateLimitMinutes}
  data-max-length={maxMessageLength}
  data-math-answer={randomProblem.answer}
  data-success-message={successMessage}
  data-error-message={errorMessage}
>
  <!-- Honeypot field - bots will fill this, humans won't see it -->
  <input
    name="website"
    type="text"
    class="honeypot"
    tabindex="-1"
    autocomplete="off"
    aria-hidden="true"
  />

  <div class="form-field">
    <label for="contact-name" class="form-label"> Name * </label>
    <input
      id="contact-name"
      name="name"
      type="text"
      required
      minlength="2"
      maxlength="100"
      class="form-input"
      autocomplete="name"
    />
  </div>

  <div class="form-field">
    <label for="contact-email" class="form-label"> Email * </label>
    <input
      id="contact-email"
      name="email"
      type="email"
      required
      maxlength="254"
      class="form-input"
      autocomplete="email"
    />
  </div>

  <div class="form-field">
    <label for="contact-message" class="form-label"> Message * </label>
    <textarea
      id="contact-message"
      name="message"
      required
      minlength="10"
      maxlength={maxMessageLength}
      class="form-input form-textarea"
      placeholder="Please tell me about yourself and your inquiry..."
      rows="5"></textarea>
  </div>

  {
    showMathCaptcha && (
      <div class="form-field">
        <label for="contact-math" class="form-label">
          Security check: {randomProblem.question} *
        </label>
        <input
          id="contact-math"
          name="math"
          type="number"
          required
          min="1"
          max="20"
          class="form-input"
          style="max-width: 100px;"
        />
      </div>
    )
  }

  <button type="submit" id="submit-button" class="submit-button">
    Send Message
  </button>

  <div id="form-message" class="form-message"></div>
  <div id="rate-limit-message" class="rate-limit-message">
    Please wait a moment before sending another message.
  </div>
</form>

<script>
  class ContactForm {
    constructor(form) {
      this.form = form
      this.messageBox = form.querySelector('#form-message')
      this.submitButton = form.querySelector('#submit-button')
      this.rateLimitMessage = form.querySelector('#rate-limit-message')

      // Get configuration from data attributes
      this.config = {
        apiEndpoint: form.dataset.apiEndpoint,
        rateLimitMinutes: parseInt(form.dataset.rateLimit),
        maxLength: parseInt(form.dataset.maxLength),
        mathAnswer: form.dataset.mathAnswer,
        successMessage: form.dataset.successMessage,
        errorMessage: form.dataset.errorMessage,
      }

      this.init()
    }

    init() {
      this.form.addEventListener('submit', this.handleSubmit.bind(this))
    }

    isRateLimited() {
      const lastSubmission = localStorage.getItem('lastFormSubmission')
      if (!lastSubmission) return false

      const now = Date.now()
      const timeDiff = now - parseInt(lastSubmission)
      return timeDiff < this.config.rateLimitMinutes * 60 * 1000
    }

    showRateLimit() {
      this.rateLimitMessage.style.display = 'block'
      setTimeout(() => {
        this.rateLimitMessage.style.display = 'none'
      }, 5000)
    }

    hasSpamKeywords(message) {
      const spamKeywords = [
        'crypto',
        'bitcoin',
        'investment',
        'trading',
        'loan',
        'viagra',
        'casino',
        'gambling',
        'winner',
        'click here',
        'limited time',
        'make money',
        'work from home',
        'guarantee',
        'risk-free',
        'no obligation',
        'nigerian prince',
        'inheritance',
        'lottery',
        'million dollars',
        'SEO',
        'free gift',
        'act now',
        'special promotion',
        'weight loss',
        'miracle cure',
        'undefined',
      ]
      const lowerMessage = message.toLowerCase()
      return spamKeywords.some((keyword) => lowerMessage.includes(keyword))
    }

    hasExcessiveLinks(message) {
      const linkRegex = /(https?:\/\/[^\s]+)/gi
      const links = message.match(linkRegex) || []
      return links.length > 2
    }

    showMessage(text, type = 'error') {
      this.messageBox.textContent = text
      this.messageBox.className = `form-message ${type}`
    }

    setButtonState(disabled, text) {
      this.submitButton.disabled = disabled
      this.submitButton.textContent = text
    }

    async handleSubmit(e) {
      e.preventDefault()

      // Rate limiting check
      if (this.isRateLimited()) {
        this.showRateLimit()
        return
      }

      // Get form data
      const formData = new FormData(this.form)
      const data = {
        name: formData.get('name').trim(),
        email: formData.get('email').trim(),
        message: formData.get('message').trim(),
        math: formData.get('math'),
        website: formData.get('website'), // honeypot
      }

      // Client-side validation
      if (data.website) {
        this.showMessage('Error: Please try again.')
        return
      }

      if (this.config.mathAnswer && data.math !== this.config.mathAnswer) {
        this.showMessage('Please solve the math question correctly.')
        return
      }

      if (this.hasSpamKeywords(data.message)) {
        this.showMessage(
          'Your message contains content that appears to be spam. Please revise and try again.'
        )
        return
      }

      if (this.hasExcessiveLinks(data.message)) {
        this.showMessage('Please limit links in your message.')
        return
      }

      // Submit form
      this.setButtonState(true, 'Sending...')

      try {
        const response = await fetch(
          'https://vn4eo2dz4loerb452wl4lwne7e0ppsev.lambda-url.ca-central-1.on.aws/',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify({
              name: data.name,
              email: data.email,
              message: data.message,
              timestamp: Date.now(),
              userAgent: navigator.userAgent.substring(0, 200),
            }),
          }
        )

        if (response.ok) {
          this.form.reset()
          this.showMessage(this.config.successMessage, 'success')
          localStorage.setItem('lastFormSubmission', Date.now().toString())
        } else {
          throw new Error('Network response was not ok')
        }
      } catch (error) {
        console.error('Contact form error:', error)
        this.showMessage(this.config.errorMessage)
      } finally {
        setTimeout(() => {
          this.setButtonState(false, 'Send Message')
        }, 2000)
      }
    }
  }

  // Initialize all contact forms on the page
  document.addEventListener('DOMContentLoaded', () => {
    const forms = document.querySelectorAll('#contact-form')
    forms.forEach((form) => new ContactForm(form))
  })
</script>
